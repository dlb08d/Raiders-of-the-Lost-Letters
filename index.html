<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Raiders of the Lost Letters</title>
  <style>
    :root{
      --bg:#0e0b05; --panel:#1b140a; --ink:#ead7a1; --ink-2:#d8c695; --accent:#e0b85a; --good:#35d16f; --bad:#ff6464; --ui:#2a2115;
      --btn:#3a2e1d; --btn-b:#4b3a22; --gold:#c99b3b; --muted:#cdbd90;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,sans-serif; color:var(--ink);
      background:radial-gradient(circle at 60% 0%, #3a2a13 0%, #1a140a 50%, #0e0b05 100%);
      background-image:
        radial-gradient(transparent 0 6px, rgba(0,0,0,.18) 7px),
        repeating-linear-gradient(45deg, rgba(255,255,255,.03) 0 6px, rgba(0,0,0,.03) 6px 12px);
      background-blend-mode:multiply;
      min-height:100dvh; display:flex; align-items:flex-start; justify-content:center; padding:16px;
    }
    .card{ width:min(1024px,100%); background:rgba(40,29,16,.55); border:1px solid rgba(255,255,255,.07);
      border-radius:16px; padding:16px 16px 18px; box-shadow:0 10px 30px rgba(0,0,0,.45); backdrop-filter:blur(6px);
    }
    h1.classic{ margin:0 0 8px; font-size:clamp(24px, 4.8vw, 40px); letter-spacing:.8px; color:transparent;
      background:linear-gradient(180deg,#f7e3a5,#d7b75b,#946b20); -webkit-background-clip:text; background-clip:text;
      text-shadow:0 2px 0 rgba(0,0,0,.3);
    }
    #intro{ margin:8px 0 12px; padding:10px; background:#fff3d4; color:#5b3a0c; border:2px solid #c89b3c; border-radius:10px;
      font-size:clamp(14px, 1.8vw, 18px); text-align:center;
    }
    .muted{color:var(--muted); font-size:14px}
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center}
    .stack{display:grid; gap:10px}
    button{ background:var(--btn); border:1px solid var(--btn-b); color:var(--ink); padding:10px 14px; border-radius:10px; cursor:pointer;
      transition:transform .06s ease,border-color .2s ease; font-size:16px; line-height:1;
    }
    button:hover{border-color:#705127} button:active{transform:translateY(1px)}
    button.primary{ background:linear-gradient(180deg,#c99b3b,#a87a28); border-color:#c99b3b; color:#1a1207 }
    button.ghost{ background:transparent }
    select, textarea, input[type="text"]{ width:100%; background:var(--ui); border:1px solid #3a2e1d; color:var(--ink);
      padding:10px 12px; border-radius:10px; outline:none; font-size:16px;
    }
    textarea{ min-height:120px; resize:vertical }
    .hidden{display:none}
    .center{display:grid; place-items:center; text-align:center}
    .stat{ background:var(--ui); border:1px solid #3a2e1d; color:var(--ink); padding:6px 10px; border-radius:10px; font-size:13px }
    .status{ min-height:22px } .status.good{color:var(--good)} .status.bad{color:var(--bad)}
    kbd{background:var(--ui); border:1px solid #3a2e1d; border-bottom-width:3px; padding:2px 6px; border-radius:6px; font-size:12px}

    /* Map area */
    .map-wrap{ position:relative; width:100%; height:clamp(180px, 28vh, 260px); border:1px solid #3a2e1d; border-radius:14px; background:#2a2115; overflow:hidden; margin-top:6px }
    .parchment{ position:absolute; inset:0; opacity:.22; background:
      radial-gradient(circle at 30% 20%, #fff8 0 2px, transparent 3px),
      radial-gradient(circle at 70% 70%, #fff8 0 2px, transparent 3px),
      url('data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"400\" height=\"100\"><defs><filter id=\"n\"><feTurbulence baseFrequency=\"0.01\" numOctaves=\"2\" seed=\"2\"/></filter></defs><rect width=\"100%\" height=\"100%\" fill=\"%23cbb37a\"/><rect width=\"100%\" height=\"100%\" fill=\"%23b99f67\" filter=\"url(%23n)\" opacity=\"0.4\"/></svg>'); background-size:cover }
    svg#map{ position:absolute; inset:0; width:100%; height:100% }
    #trail{ stroke:#8b5e2b; stroke-width:10; fill:none; stroke-linecap:round; stroke-dasharray:18 18 }
    .xmark{ position:absolute; transform:translate(-50%,-50%); font-size:18px; color:#d8b46a; text-shadow:0 1px 0 #0007; pointer-events:none; z-index:2 }
    .landmark{ position:absolute; transform:translate(-50%,-50%) rotate(0deg); filter:drop-shadow(0 2px 2px rgba(0,0,0,.5)); pointer-events:none; z-index:1 }
    .avatar, .chest{ position:absolute; transform:translate(-50%,-50%); width:60px; height:60px; pointer-events:none; z-index:3 }
    .avatar svg, .chest svg{ filter:drop-shadow(0 4px 3px rgba(0,0,0,.6)) }
    .bounce{ animation:bounce .5s ease } @keyframes bounce{0%{transform:translate(-50%,-55%)}50%{transform:translate(-50%,-50%)}100%{transform:translate(-50%,-52%)}}
    .shake{ animation:shake .35s ease } @keyframes shake{0%,100%{transform:translate(-50%,-50%)}20%{transform:translate(calc(-50% + 6px),-50%)}40%{transform:translate(calc(-50% - 6px),-50%)}60%{transform:translate(calc(-50% + 4px),-50%)}80%{transform:translate(calc(-50% - 4px),-50%)}}

    /* Practice pad */
    #practiceWrap{ background:#251d11; border:1px solid #3a2e1d; border-radius:12px; padding:8px }
    #canvas{ width:100%; height:200px; background:repeating-linear-gradient(0deg,#1f1a10 0 2px, #231b11 2px 4px); border:1px dashed #5a492f; border-radius:8px; display:block; touch-action:none }
    .toolbar{ display:flex; gap:8px; align-items:center; justify-content:space-between; margin-top:6px }
  </style>
</head>
<body>
  <div class="card" role="application" aria-label="Raiders of the Lost Letters game">
    <h1 class="classic">Raiders of the Lost Letters</h1>
    <div id="intro">üó∫Ô∏è Welcome, brave raider! Spell each word to guide your explorer across the map and claim the treasure. Mistakes slow the journey, but every correct word marks your map. Can you reach the chest with the fewest repeats?</div>

    <!-- Stats -->
    <header class="row" style="justify-content:space-between; margin-bottom:8px">
      <div class="row">
        <div class="stat" id="statTotal">Words: 0</div>
        <div class="stat" id="statMastered">Mastered: 0</div>
        <div class="stat" id="statRepeats">Repeats: 0</div>
        <div class="stat" id="statBest">Personal Best: ‚Äî</div>
      </div>
    </header>

    <!-- Setup: layout per your request -->
    <section id="setup" class="stack">
      <!-- Top row: Load Chapter button to the LEFT of dropdown -->
      <div class="row">
        <button id="loadChapterBtn">Load Chapter</button>
        <select id="chapterSel" title="Choose Chapter"></select>
      </div>
      <!-- Second row under dropdown: Use These Words + Shuffle Again -->
      <div class="row">
        <button id="useWordsBtn" class="primary">Use These Words</button>
        <button id="shuffleBtn" class="ghost">Shuffle Again</button>
      </div>
      <!-- Then the word list textarea (dropdown is above it) -->
      <textarea id="wordInput" placeholder="Paste your weekly words here‚Ä¶"></textarea>
      <!-- Small options -->
      <div class="row">
        <label class="muted"><input type="checkbox" id="sayWords" checked> Speak the word</label>
      </div>
    </section>

    <!-- Play area -->
    <section id="play" class="stack hidden" aria-live="polite">
      <div class="map-wrap" id="mapWrap" aria-hidden="true">
        <div class="parchment"></div>
        <svg id="map" viewBox="0 0 1000 220" preserveAspectRatio="none">
          <path id="trail" d="M60,160 C150,60 260,200 340,120 S520,40 600,120 760,200 880,120" />
        </svg>
        <div class="avatar" id="avatar" style="left:60px;top:160px">
          <svg viewBox="0 0 80 80" aria-hidden="true">
            <ellipse cx="40" cy="26" rx="26" ry="8" fill="#4a3926"/>
            <path d="M28 15 q12-8 24 0 l-4 14 h-16z" fill="#3a2c1e"/>
            <circle cx="40" cy="36" r="10" fill="#f0c799"/>
            <path d="M26 48 h28 l6 22 h-40z" fill="#5b3e24"/>
            <rect x="36" y="48" width="8" height="8" fill="#d9d2c2"/>
            <rect x="24" y="58" width="32" height="4" fill="#3b2a15"/>
            <path d="M28 48 l24 22" stroke="#caa06a" stroke-width="4"/>
          </svg>
        </div>
        <div class="chest" id="chest">
          <svg viewBox="0 0 80 80" aria-hidden="true">
            <rect x="10" y="30" width="60" height="30" rx="4" fill="#6b3f1f" stroke="#2c1b0e" stroke-width="3"/>
            <path d="M10 30 q30-18 60 0 v8 h-60z" fill="#8c5228" stroke="#2c1b0e" stroke-width="3"/>
            <rect x="37" y="40" width="6" height="10" fill="#c99b3b" />
          </svg>
        </div>
      </div>

      <div class="center">
        <div class="muted">Spell the word to move along the map:</div>
        <div class="row" style="gap:8px; margin-top:6px">
          <button id="hearBtn">üîä Hear</button>
          <button id="hintBtn" class="ghost">Hint</button>
          <button id="skipBtn" class="ghost">Skip</button>
          <button id="endBtn" class="ghost">End</button>
        </div>
      </div>

      <label class="sr-only" for="answer">Type your spelling</label>
      <div class="row">
        <input id="answer" type="text" placeholder="Type the word and press Enter" autocomplete="off" style="flex:1; font-size:18px" />
        <button id="submitBtn" class="primary">‚ùå Mark the Map</button>
      </div>
      <!-- Music mute button BELOW the type word bar -->
      <div class="row">
        <button id="musicBtn" class="ghost" title="Mute/unmute music and SFX">üîä Music & SFX</button>
      </div>

      <!-- Practice Here toggle ABOVE the scratch pad -->
      <div class="row">
        <button id="togglePracticeBtn" class="ghost">‚úçÔ∏è <span>Practice Here</span></button>
      </div>
      <div id="practiceWrap" class="stack">
        <canvas id="canvas"></canvas>
        <div class="toolbar">
          <div class="row" style="gap:8px">
            <button id="undoBtn" class="ghost" type="button">Undo</button>
            <button id="clearBtn" class="ghost" type="button">Clear</button>
          </div>
          <span class="muted">Tip: Draw with finger/mouse. Audio starts after your first tap.</span>
        </div>
      </div>

      <div class="row">
        <div class="stat" id="statCorrect">Correct: 0</div>
        <div class="stat" id="statWrong">Wrong: 0</div>
        <div class="stat" id="statMasteredPlay">Mastered: 0/0</div>
      </div>
    </section>

    <!-- Results -->
    <section id="results" class="stack hidden center">
      <h2>üéâ You found the treasure!</h2>
      <div id="summary" class="muted"></div>
      <div id="bestNote" class="muted"></div>
      <div class="row" style="margin-top:10px">
        <button class="primary" id="restartBtn">Hunt Again</button>
        <button id="editBtn">Edit Word List</button>
      </div>
    </section>
  </div>

  <div id="confetti" style="position:fixed; inset:0; pointer-events:none"></div>

  <!-- Background music: attempt autoplay; iOS fallback handled in script -->
  <audio id="bgm" src="game-over-danijel-zambo-main-version-1394-02-03.mp3" loop preload="auto"></audio>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const normalize = w => w.toLowerCase().trim().replace(/[^a-z']/g, "");
  const shuffle = arr => arr.sort(() => Math.random() - 0.5);

  const PREBUILT = {
    'Chapter 1':[ 'atlas','travel','elastic','having','satisfy','candle','captain','pasture','manage','Canada','example','fantastic','scramble','hamburger','enough','because','absent','absolute','access','accurate' ],
    'Chapter 2':[ 'raise','volcano','radio','straight','eighth','conveyed','Savior','neighborhood','survey','usually','weight','remember','nature','repaid','faithful','reweigh','contain','unable','disobey','unclaimed' ],
    'Chapter 3':[ 'hotel','selfish','meant','breath','instead','several','leather','Mexico','protect','already','connect','pleasant','seventeen','everybody','music','during','envelope','entrance','expedition','exclamation' ],
    'Chapter 4':[ 'enemies','beaches','seasonal','keyboard','southern','northern','decode','dehydrate','preseason','prearrange','idea','niece','belief','either','secret','money','reason','receive','chimney','breathe' ],
    'Chapter 5':[ 'living','hospitals','stitch','fifteenth','picnic','sandwich','pillow','whichever','skillful','products','biscuit','mountains','comics','immature','picture','impossible','sincere','inland','difficult','invisible' ],
  };
  PREBUILT['Chapter 6 ‚Äì All Above'] = Array.from(new Set(Object.values(PREBUILT).flat()));

  const chapterSel = $('#chapterSel');
  Object.keys(PREBUILT).forEach(name=>{
    const opt=document.createElement('option'); opt.value=name; opt.textContent=name; chapterSel.appendChild(opt);
  });
  $('#loadChapterBtn').addEventListener('click', ()=>{
    const list = PREBUILT[chapterSel.value] || [];
    $('#wordInput').value = list.join('\n');
  });
  $('#useWordsBtn').addEventListener('click', start);
  $('#shuffleBtn').addEventListener('click', ()=>{
    const words = $('#wordInput').value.split(/[\n,]+/).map(w=>w.trim()).filter(Boolean);
    if(!words.length){ alert('Paste or load some words first.'); return; }
    $('#wordInput').value = shuffle(words).join('\n');
  });

  // Speech (NOT muted by music toggle)
  const speak = (text) => {
    if (!$('#sayWords').checked) return;
    const u = new SpeechSynthesisUtterance(text);
    u.rate = 0.95; u.pitch = 1.0; u.lang = 'en-US';
    try { speechSynthesis.cancel(); } catch(e) {}
    speechSynthesis.speak(u);
  };

  // WebAudio for SFX
  let audioCtx;
  const ensureAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)(); if (audioCtx.state === 'suspended') audioCtx.resume(); };
  let audioMuted = false; // mutes MUSIC + SFX only

  function tone(freq=440, dur=0.12, type='sine', vol=0.2){
    if(audioMuted) return;
    ensureAudio(); const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=vol; o.connect(g); g.connect(audioCtx.destination);
    o.start(); setTimeout(()=>o.stop(), dur*1000);
  }
  function coin(){ tone(880,.07,'square',.22); setTimeout(()=>tone(1320,.08,'square',.20),60); }
  function miss(){ tone(220,.12,'sawtooth',.18); setTimeout(()=>tone(180,.14,'sawtooth',.16),90); }
  function fanfare(){ [523,659,784,1046].forEach((f,i)=>setTimeout(()=>tone(f,.12,'triangle',.22), i*140)); }

  // Pen scratch loop
  let scratchNode=null, scratchGain=null;
  function startScratch(){
    if(audioMuted) return;
    ensureAudio();
    const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate*2, audioCtx.sampleRate);
    const data = buffer.getChannelData(0); for(let i=0;i<data.length;i++){ data[i] = (Math.random()*2-1)*0.2; }
    scratchNode = audioCtx.createBufferSource(); scratchNode.buffer=buffer; scratchNode.loop=true;
    scratchGain = audioCtx.createGain(); scratchGain.gain.value=0.25;
    scratchNode.connect(scratchGain); scratchGain.connect(audioCtx.destination); scratchNode.start(0);
  }
  function stopScratch(){ if(scratchNode){ try{scratchNode.stop();}catch(e){} scratchNode.disconnect(); scratchGain.disconnect(); scratchNode=null; scratchGain=null; } }

  // Background music: try to autoplay; unlock on first gesture
  const bgm = document.getElementById('bgm');
  async function tryAutoplay(){
    try{ if(!audioMuted){ await bgm.play(); } }catch(e){ /* iOS will block until a user gesture */ }
  }
  document.addEventListener('DOMContentLoaded', tryAutoplay, {once:true});
  const unlock = async () => { ensureAudio(); if(!audioMuted){ try{ await bgm.play(); }catch(e){} } document.removeEventListener('pointerdown', unlock); };
  document.addEventListener('pointerdown', unlock);

  $('#musicBtn').addEventListener('click', ()=>{
    audioMuted = !audioMuted;
    if(audioMuted){ bgm.pause(); $('#musicBtn').textContent = 'üîá Music & SFX'; }
    else { bgm.play().catch(()=>{}); $('#musicBtn').textContent = 'üîä Music & SFX'; }
  });

  // Confetti
  function confetti(n=60){ const layer=$('#confetti'); for(let i=0;i<n;i++){ const el=document.createElement('i'); el.style.position='absolute'; el.style.width='10px'; el.style.height='10px'; el.style.left=Math.random()*100+'vw'; el.style.background=['gold','#e0b85a','#ffd54a','#f5c36b'][i%4]; el.style.opacity='0.9'; el.style.transition='transform 1.2s ease, opacity 1.2s ease'; layer.appendChild(el); setTimeout(()=>{ el.style.transform='translateY(120vh) rotate(720deg)'; el.style.opacity='0'; }, 10); setTimeout(()=>layer.removeChild(el), 1400); } }

  // Game State
  let queue=[], current=null, total=0;
  let stats={correct:0, wrong:0, attempts:0};
  let xPositions=[];
  let path, pathLength=1;

  const repeats = () => Math.max(0, stats.attempts - total);

  function parseWords(text){
    const parts=text.split(/[\n,]+/).map(w=>w.trim()).filter(Boolean);
    const seen=new Set(); const list=[];
    for(const raw of parts){ const key=normalize(raw); if(!key||seen.has(key)) continue; seen.add(key); list.push({raw,key,mastered:false}); }
    return list;
  }

  function start(){
    const raw=$('#wordInput').value;
    const words=parseWords(raw);
    if(!words.length){ alert('Please enter or load at least one word.'); return; }
    queue = shuffle(words.slice());
    total = queue.length; stats={correct:0,wrong:0,attempts:0};

    $('#statTotal').textContent = `Words: ${total}`;
    $('#statMastered').textContent = `Mastered: 0`;
    $('#statMasteredPlay').textContent = `Mastered: 0/${total}`;
    $('#statCorrect').textContent = 'Correct: 0';
    $('#statWrong').textContent = 'Wrong: 0';
    $('#statRepeats').textContent = `Repeats: 0`;
    const best = localStorage.getItem('treasure_best_repeats'); $('#statBest').textContent = `Personal Best: ${best!==null?best:'‚Äî'}`;

    $('#setup').classList.add('hidden'); $('#results').classList.add('hidden'); $('#play').classList.remove('hidden');

    path = document.getElementById('trail'); pathLength = path.getTotalLength? path.getTotalLength() : 1000;
    placeXMarks(total); placeLandmarks(total); placeChest(); updateAvatarToIndex(0);
    next();
  }

  function masteredCount(){ return queue.filter(w=>w.mastered).length; }

  function next(){
    while(queue.length && queue[0].mastered) queue.shift();
    if(queue.length===0){ finish(); return; }
    current = queue[0];
    $('#answer').value='';
    $('#answer').focus();
    speak(current.raw);
  }

  function submit(){
    if(!current) return;
    const val = normalize($('#answer').value);
    if(!val) return;
    stats.attempts++;

    if(val===current.key){
      current.mastered=true; stats.correct++;
      $('#statCorrect').textContent = `Correct: ${stats.correct}`;
      const mastered = masteredCount();
      $('#statMasteredPlay').textContent = `Mastered: ${mastered}/${total}`;
      $('#statMastered').textContent = `Mastered: ${mastered}`;
      $('#avatar').classList.remove('shake'); $('#avatar').classList.add('bounce'); coin();
      updateAvatarToIndex(mastered);
      queue.shift();
      setTimeout(()=>{ $('#avatar').classList.remove('bounce'); next(); }, 350);
    } else {
      stats.wrong++; $('#statWrong').textContent = `Wrong: ${stats.wrong}`; $('#avatar').classList.remove('bounce'); $('#avatar').classList.add('shake'); miss();
      queue.shift(); const insertAt = Math.min(3, queue.length); queue.splice(insertAt,0,current);
      $('#statRepeats').textContent = `Repeats: ${repeats()}`;
      setTimeout(()=>$('#avatar').classList.remove('shake'), 360);
      setTimeout(next, 420);
    }
  }

  function hint(){ if(!current) return; const first=current.raw[0]; alert(`Hint: starts with ‚Äú${first}‚Äù`); }
  function skip(){ if(!current) return; queue.shift(); queue.splice(Math.min(3, queue.length), 0, current); setTimeout(next, 260); }
  function finish(){
    updateAvatarToIndex(total-1); fanfare(); confetti(90);
    $('#play').classList.add('hidden'); $('#results').classList.remove('hidden');
    const rpt = repeats();
    $('#summary').innerHTML = `Words: <b>${total}</b> ¬∑ Correct: <b>${stats.correct}</b> ¬∑ Wrong: <b>${stats.wrong}</b><br><b>Repeats (score): ${rpt}</b> ‚Äî lower is better!`;
    const key='treasure_best_repeats'; const curr = localStorage.getItem(key);
    if(curr===null || rpt < Number(curr)){ localStorage.setItem(key, String(rpt)); $('#bestNote').innerHTML = `üèÜ New personal best! Your best ‚Äúfewest repeats‚Äù is now <b>${rpt}</b>.`; }
    else { $('#bestNote').innerHTML = `Best to beat: <b>${curr}</b> repeats. Try to beat it next round!`; }
    $('#statBest').textContent = `Personal Best: ${localStorage.getItem(key)}`;
  }

  // Map helpers
  function getPointAtFrac(fr){ const d=Math.max(0,Math.min(1,fr))*pathLength; return path.getPointAtLength(d); }
  function getNormalAtFrac(fr){
    const d=Math.max(0,Math.min(1,fr))*pathLength; const p1=path.getPointAtLength(Math.max(0,d-1)); const p2=path.getPointAtLength(Math.min(pathLength,d+1));
    const dx=p2.x-p1.x, dy=p2.y-p1.y, len=Math.hypot(dx,dy)||1; return {nx:-dy/len, ny:dx/len};
  }
  let xPositions=[];
  function placeXMarks(n){
    Array.from(document.querySelectorAll('.xmark')).forEach(el=>el.remove());
    xPositions=[]; if(n<=0) return;
    for(let i=0;i<n;i++){ const fr=(i)/(n); xPositions.push(fr); const pt=getPointAtFrac(fr);
      const el=document.createElement('div'); el.className='xmark'; el.textContent='‚ùå'; el.style.left=pt.x+'px'; el.style.top=pt.y+'px'; $('#mapWrap').appendChild(el);
    }
  }
  function placeChest(){ const pt=getPointAtFrac(0.995); const chest=$('#chest'); chest.style.left=pt.x+'px'; chest.style.top=pt.y+'px'; }
  function updateAvatarToIndex(idx){ const i=Math.max(0,Math.min(idx,xPositions.length-1)); const pt=getPointAtFrac(xPositions[i]); const av=$('#avatar'); av.style.left=pt.x+'px'; av.style.top=pt.y+'px'; }
  const LANDMARK_POOL=['üå¥','üå≤','‚ò†Ô∏è','üî•','üß≠','ü™®','üõ¢Ô∏è','‚õ∫','ü™ô','üõ∂'];
  function placeLandmarks(n){
    Array.from(document.querySelectorAll('.landmark')).forEach(el=>el.remove()); if(n<=1) return;
    const avatarH = $('#avatar').getBoundingClientRect().height||60; const baseSize=Math.round(avatarH*0.25);
    let prev=null;
    for(let i=0;i<n-1;i++){
      let type=LANDMARK_POOL[Math.floor(Math.random()*LANDMARK_POOL.length)];
      if(type===prev) type=LANDMARK_POOL[(LANDMARK_POOL.indexOf(type)+1)%LANDMARK_POOL.length];
      prev=type;
      const mid=(xPositions[i]+xPositions[i+1])/2; const pt=getPointAtFrac(mid); const normal=getNormalAtFrac(mid); const offset=36+Math.round(Math.random()*16);
      const el=document.createElement('div'); el.className='landmark'; el.textContent=type;
      const bump=(window.innerWidth>1000?1.15:window.innerWidth<420?0.95:1.0); const size=Math.min(28, Math.round(baseSize*bump*1.2));
      el.style.left=(pt.x+normal.nx*offset)+'px'; el.style.top=(pt.y+normal.ny*offset)+'px'; el.style.fontSize=size+'px'; el.style.rotate=((Math.random()*36-18).toFixed(1)+'deg');
      $('#mapWrap').appendChild(el);
    }
  }

  // Practice canvas (CSS-pixel math)
  const canvas=$('#canvas'); const ctx=canvas.getContext('2d'); let strokes=[]; let drawing=false; let dpr=1;
  function resizeCanvas(){ const r=canvas.getBoundingClientRect(); dpr=window.devicePixelRatio||1; canvas.width=Math.floor(r.width*dpr); canvas.height=Math.floor(r.height*dpr); redraw(); }
  function toCanvasPoint(e){ const r=canvas.getBoundingClientRect(); return {x:(e.clientX-r.left), y:(e.clientY-r.top)}; }
  function redraw(){ ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.save(); ctx.scale(dpr,dpr); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle='#ead7a1'; ctx.lineWidth=3.5; for(const s of strokes){ ctx.beginPath(); for(let i=0;i<s.length;i++){ const p=s[i]; if(i===0) ctx.moveTo(p.x,p.y); else ctx.lineTo(p.x,p.y);} ctx.stroke(); } ctx.restore(); }
  function down(e){ ensureAudio(); if(!audioMuted) startScratch(); drawing=true; const p=toCanvasPoint(e); strokes.push([p]); redraw(); }
  function move(e){ if(!drawing) return; const p=toCanvasPoint(e); strokes[strokes.length-1].push(p); redraw(); }
  function up(){ drawing=false; stopScratch(); }
  canvas.addEventListener('pointerdown', e=>{ e.preventDefault(); canvas.setPointerCapture(e.pointerId); down(e); });
  canvas.addEventListener('pointermove', e=>{ if(!drawing) return; e.preventDefault(); move(e); });
  canvas.addEventListener('pointerup', e=>{ e.preventDefault(); up(); });
  canvas.addEventListener('pointercancel', up);
  $('#undoBtn').addEventListener('click', ()=>{ strokes.pop(); redraw(); });
  $('#clearBtn').addEventListener('click', ()=>{ strokes=[]; redraw(); });

  // Buttons & interactions
  function submit(){ /* defined later but used by events above */ }
  $('#submitBtn').addEventListener('click', submit);
  $('#answer').addEventListener('keydown', e=>{ if(e.key==='Enter') submit(); });
  $('#hearBtn').addEventListener('click', ()=>{ if(current) speak(current.raw); });
  $('#hintBtn').addEventListener('click', ()=>{ if(!current) return; const first=current.raw[0]; alert(`Hint: starts with ‚Äú${first}‚Äù`); });
  $('#skipBtn').addEventListener('click', ()=>{ if(!current) return; queue.shift(); queue.splice(Math.min(3, queue.length), 0, current); setTimeout(next, 260); });
  $('#endBtn').addEventListener('click', ()=>{ updateAvatarToIndex(total-1); fanfare(); confetti(90); $('#play').classList.add('hidden'); $('#results').classList.remove('hidden'); });
  $('#restartBtn').addEventListener('click', ()=>{ $('#results').classList.add('hidden'); $('#setup').classList.remove('hidden'); });
  $('#editBtn').addEventListener('click', ()=>{ $('#results').classList.add('hidden'); $('#setup').classList.remove('hidden'); });
  $('#togglePracticeBtn').addEventListener('click', ()=>{ const w=$('#practiceWrap'); w.classList.toggle('hidden'); });

  $$('button').forEach(btn=>{ btn.setAttribute('type','button'); btn.style.touchAction='manipulation'; btn.addEventListener('keydown', e=>{ if(e.key===' ') e.preventDefault(); }); });

  $('#mapWrap').addEventListener('click', ()=>$('#answer').focus());

  function relayout(){ resizeCanvas(); if($('#play').classList.contains('hidden')) return; placeXMarks(total); placeLandmarks(total); placeChest(); const mastered=masteredCount(); updateAvatarToIndex(mastered); }
  window.addEventListener('resize', ()=>{ clearTimeout(window.__rsz); window.__rsz=setTimeout(relayout,120); });
  window.addEventListener('orientationchange', ()=>{ setTimeout(relayout,150); });

  setTimeout(resizeCanvas, 50);
  const best = localStorage.getItem('treasure_best_repeats'); $('#statBest').textContent = `Personal Best: ${best!==null?best:'‚Äî'}`;

  // Re-define submit now (after helpers exist)
  function submit(){
    if(!current) return;
    const val = normalize($('#answer').value);
    if(!val) return;
    stats.attempts++;

    if(val===current.key){
      current.mastered=true; stats.correct++;
      $('#statCorrect').textContent = `Correct: ${stats.correct}`;
      const mastered = masteredCount();
      $('#statMasteredPlay').textContent = `Mastered: ${mastered}/${total}`;
      $('#statMastered').textContent = `Mastered: ${mastered}`;
      $('#avatar').classList.remove('shake'); $('#avatar').classList.add('bounce'); coin();
      updateAvatarToIndex(mastered);
      queue.shift();
      setTimeout(()=>{ $('#avatar').classList.remove('bounce'); next(); }, 350);
    } else {
      stats.wrong++; $('#statWrong').textContent = `Wrong: ${stats.wrong}`; $('#avatar').classList.remove('bounce'); $('#avatar').classList.add('shake'); miss();
      queue.shift(); const insertAt = Math.min(3, queue.length); queue.splice(insertAt,0,current);
      $('#statRepeats').textContent = `Repeats: ${repeats()}`;
      setTimeout(()=>$('#avatar').classList.remove('shake'), 360);
      setTimeout(next, 420);
    }
  }
})();
</script>
</body>
</html>
