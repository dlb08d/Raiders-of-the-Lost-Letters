
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Raiders of the Lost Letters</title>
<style>
  :root{
    --bg:#f4e2c2; --ink:#3b2a14; --accent:#d4af37; --panel:#f7e8c7;
    --border:#8b4513; --trail:#7a4f21; --x:#a66a2a; --good:#1f8b45; --bad:#c0392b;
  }
  *{box-sizing:border-box}
  body{ margin:0; background:var(--bg); color:var(--ink); font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Inter,Arial,sans-serif; }
  header{ padding:16px 14px 6px; text-align:center; }
  h1{ margin:0 0 4px; color:var(--border); text-shadow:1px 1px #fff; font-size:24px; }
  .tag{ color:#6b5432; font-size:14px }
  .wrap{ width:min(980px, 94%); margin:0 auto 20px; }

  .grid{ display:grid; gap:10px; }
  .panel{ background:var(--panel); border:2px solid var(--border); border-radius:14px; padding:12px; }

  /* Textarea for pasting word lists */
  textarea{
    width:100%; min-height:120px; resize:vertical;
    border:2px solid var(--border); border-radius:10px; padding:10px; font-size:15px; background:#fffdf5; color:#2a1d0e;
  }

  .controls{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
  button{
    padding:10px 14px; border:none; border-radius:10px; background:var(--accent); color:#1f1408; cursor:pointer; font-size:15px;
  }
  button.secondary{ background:#caa33a }
  input[type="text"]{
    width:100%; padding:10px 12px; border:2px solid var(--border); border-radius:10px; font-size:18px; background:#fffdf5;
  }
  .stats{ display:flex; flex-wrap:wrap; gap:8px; font-size:13px; color:#5a4123; }
  .pill{ padding:6px 10px; background:#f9edcf; border:1px solid #d2b473; border-radius:999px; }

  /* Treasure map */
  .map-box{
    position:relative; width:100%; height:220px;  /* TALLER so avatar doesn't get clipped */
    background:linear-gradient(180deg,#e8d3a1,#d6b97b);
    border:3px solid var(--border); border-radius:16px; overflow:hidden;
  }
  svg#map{ position:absolute; inset:0; }
  #trail{ stroke:var(--trail); stroke-width:9; fill:none; stroke-linecap:round; stroke-dasharray:16 18; }

  /* X marks are positioned along the path using absolute DIVs */
  #xLayer{ position:absolute; inset:0; pointer-events:none; }
  .x{ position:absolute; width:14px; height:14px; transform:translate(-50%,-50%) rotate(45deg); }
  .x:before,.x:after{ content:""; position:absolute; left:50%; top:50%; width:2px; height:16px; background:var(--x); transform:translate(-50%,-50%) rotate(45deg) }
  .x:after{ transform:translate(-50%,-50%) rotate(-45deg) }

  /* Avatar placed as an absolutely positioned SVG inside the map box */
  #avatar{ position:absolute; width:70px; height:70px; transform:translate(-50%,-50%); filter:drop-shadow(0 6px 6px rgba(0,0,0,.25)); }
  .good{ color:var(--good); } .bad{ color:var(--bad); }
  .sr-only{ position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden; }
</style>
</head>
<body>
  <header>
    <h1>Raiders of the Lost Letters</h1>
    <div class="tag">Paste your words, then spell them to reach the treasure. ‚ùå marks each word on the trail.</div>
  </header>

  <main class="wrap grid">
    <!-- Word list panel -->
    <section class="panel grid">
      <label for="listBox"><strong>Word list</strong> (one per line or commas)</label>
      <textarea id="listBox">because
treasure
jungle
adventure
map
whisper
rhythm
friend
school
beautiful</textarea>
      <div class="controls">
        <button id="btnUseList">Use These Words (Shuffle)</button>
        <button id="btnHuntAgain" class="secondary">Hunt Again (Shuffle)</button>
      </div>
    </section>

    <!-- Map -->
    <section class="panel grid">
      <div class="map-box">
        <svg id="map" viewBox="0 0 1000 220" preserveAspectRatio="none" aria-hidden="true">
          <path id="trail" d="M60,160 C150,60 260,200 340,120 S520,40 600,120 760,200 880,120" />
        </svg>
        <div id="xLayer"></div>

        <!-- Avatar (explorer) -->
        <svg id="avatar" viewBox="0 0 80 80" aria-hidden="true">
          <ellipse cx="40" cy="22" rx="26" ry="8" fill="#4a3926"/>
          <path d="M28 12 q12-8 24 0 l-4 14 h-16z" fill="#3a2c1e"/>
          <circle cx="40" cy="32" r="10" fill="#f0c799"/>
          <path d="M26 44 h28 l6 22 h-40z" fill="#5b3e24"/>
          <rect x="36" y="44" width="8" height="8" fill="#d9d2c2"/>
          <rect x="24" y="54" width="32" height="4" fill="#3b2a15"/>
          <path d="M28 44 l24 22" stroke="#caa06a" stroke-width="4"/>
        </svg>
      </div>

      <label class="sr-only" for="answer">Type the word</label>
      <input id="answer" type="text" placeholder="Type the word and press Enter" autocomplete="off" />
      <div id="feedback"></div>

      <div class="stats">
        <div class="pill">Words: <span id="statTotal">0</span></div>
        <div class="pill">Mastered: <span id="statMastered">0</span></div>
        <div class="pill">Correct: <span id="statCorrect">0</span></div>
        <div class="pill">Wrong: <span id="statWrong">0</span></div>
        <div class="pill">Repeats (score): <span id="statRepeats">0</span></div>
        <div class="pill">Best: <span id="statBest">‚Äî</span></div>
      </div>

      <div class="controls">
        <button id="btnHear" class="secondary">üîä Hear Word</button>
      </div>
    </section>
  </main>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const normalize = s => s.toLowerCase().trim().replace(/[^a-z']/g,'');

  // Shuffle (Fisher-Yates)
  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  function speak(text){
    try{
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 0.95; u.pitch = 1.0; u.lang = 'en-US';
      window.speechSynthesis.speak(u);
    }catch(e){ /* ignore if unsupported */ }
  }

  // Map / path
  let path, pathLength=1;
  function initPath(){
    path = document.getElementById('trail');
    pathLength = path.getTotalLength ? path.getTotalLength() : 1000;
  }
  function setAvatarAtPercent(p){
    p = Math.max(0, Math.min(1, p));
    const d = p * pathLength;
    const pt = path.getPointAtLength(d);
    const av = $('avatar');
    av.style.left = pt.x + 'px';
    av.style.top  = pt.y + 'px';
  }
  function drawXMarks(n){
    const layer = $('xLayer'); layer.innerHTML='';
    if(n <= 0) return;
    for(let i=1;i<=n;i++){
      const p = i/n; // equal spacing along path
      const d = p * pathLength;
      const pt = path.getPointAtLength(d);
      const x = document.createElement('div');
      x.className = 'x';
      x.style.left = pt.x + 'px';
      x.style.top  = pt.y + 'px';
      layer.appendChild(x);
    }
  }

  // Game state
  let baseList = []; // strings
  let queue = [];    // [{raw,key,mastered:false}]
  let total = 0;
  let current = null;
  let stats = {correct:0, wrong:0, attempts:0};
  let stepIndex = 0; // 0..total, moves along path
  let speakLock = false;

  function repeats(){ return Math.max(0, stats.attempts - total); }

  function parseList(text){
    const parts = text.split(/[,\n]+/).map(s=>s.trim()).filter(Boolean);
    const seen = new Set(); const out=[];
    for(const raw of parts){
      const key = normalize(raw);
      if(!key || seen.has(key)) continue;
      seen.add(key); out.push(raw);
    }
    return out;
  }

  function updateStats(){
    $('statTotal').textContent = total;
    $('statMastered').textContent = queue.filter(w=>w.mastered).length;
    $('statCorrect').textContent = stats.correct;
    $('statWrong').textContent = stats.wrong;
    $('statRepeats').textContent = repeats();
    const best = localStorage.getItem('treasure_best_repeats');
    $('statBest').textContent = (best===null ? '‚Äî' : best);
  }

  function startRound(reshuffle=true){
    initPath();
    const list = reshuffle ? shuffle(baseList) : baseList.slice();
    queue = list.map(raw => ({raw, key:normalize(raw), mastered:false}));
    total = queue.length;
    stats = {correct:0, wrong:0, attempts:0};
    stepIndex = 0;
    $('answer').value = '';
    $('feedback').textContent='';
    $('feedback').className='';
    drawXMarks(total);
    updateStats();
    setAvatarAtPercent(0);
    next(true);
  }

  function next(autoSpeak=false){
    while(queue.length && queue[0].mastered) queue.shift();
    if(queue.length === 0){ return finish(); }
    current = queue[0];
    if(autoSpeak && !speakLock){
      speakLock = true;
      speak(current.raw);
      setTimeout(()=>{ speakLock=false; }, 500);
    }
    $('answer').focus();
  }

  function submit(){
    if(!current) return;
    const val = normalize($('answer').value);
    if(!val) return;
    stats.attempts++;

    if(val === current.key){
      current.mastered = true;
      stats.correct++;
      $('feedback').textContent = `‚úÖ Correct: ${current.raw}`;
      $('feedback').className = 'good';

      // progress forward one X
      stepIndex = Math.min(total, stepIndex + 1);
      setAvatarAtPercent(stepIndex/total);

      // remove mastered and continue
      queue.shift();
      updateStats();
      $('answer').value = '';
      next(true);

    } else {
      stats.wrong++;
      $('feedback').textContent = `‚ùå Oops. The word was ‚Äú${current.raw}‚Äù. We'll try it again soon.`;
      $('feedback').className = 'bad';

      // move one step back
      stepIndex = Math.max(0, stepIndex - 1);
      setAvatarAtPercent(stepIndex/total);

      // reinsert a few later
      queue.shift();
      const insertAt = Math.min(3, queue.length);
      queue.splice(insertAt, 0, current);

      updateStats();
      $('answer').value = '';
      // Only speak the new current word once
      next(true);
    }
  }

  function finish(){
    setAvatarAtPercent(1);
    const score = repeats();
    const key='treasure_best_repeats';
    const currBest = localStorage.getItem(key);
    if(currBest===null || score < Number(currBest)){ localStorage.setItem(key, String(score)); }
    $('statBest').textContent = localStorage.getItem(key);
    $('feedback').innerHTML = `üéâ You found the treasure! Repeats (score): <b>${score}</b>. Best: <b>${localStorage.getItem(key)}</b>.`;
  }

  // Events
  $('btnUseList').addEventListener('click', ()=>{
    const text = $('listBox').value;
    const parsed = parseList(text);
    if(parsed.length === 0){ alert('Please enter at least one word.'); return; }
    baseList = parsed;
    startRound(true); // shuffle
  });
  $('btnHuntAgain').addEventListener('click', ()=>{
    if(baseList.length === 0){ alert('Paste a word list first.'); return; }
    startRound(true);
  });
  $('btnHear').addEventListener('click', ()=>{ if(current) speak(current.raw); });
  $('answer').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ submit(); } });

  // Initialize best
  const best = localStorage.getItem('treasure_best_repeats');
  $('statBest').textContent = (best===null ? '‚Äî' : best);
})();
</script>
</body>
</html>
